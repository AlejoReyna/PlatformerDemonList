{% extends "base.html" %}
{% load static %}

{% block head_content %}
    <title>Stats Viewer</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
{% endblock%}
<!DOCTYPE html>
{% block container %}

    <div class="container">
        <div class="row">
            <div class="col-sm-12 col-md-10 offset-md-1 mt-5 p-3 post-container text-center">
                
                <p style="font-size: 28px; color: #454546; font-weight: bold;">Stats Viewer</p>
                
                <div style="display: flex; align-items: center; justify-content: center;">
                    <select class="form-select" style="width: 150px; border-radius: 10px; background-color: #f8f9fa; color: #495057; border: 2px solid #ced4da;" id="status" name="status" onchange="update_table_status(this);">
                        <option value="Individual">Individual</option>
                        <option value="Nations">Nations</option>
                    </select>

                    <select class="form-select" style="margin-left: 10px; width: 150px; border-radius: 10px; background-color: #f8f9fa; color: #495057; border: 2px solid #ced4da;" id="country" name="country" onchange="update_table_country(this);">
                        <option value="" selected>-- Nation --</option>
                        {% for country in countries %}
                        <option value="{{country}}">{{country}}</option>
                        {% endfor %}
                    </select>

                    <div class="offset-md-2 mt-4 p-1 post-container-1">
                        <input class="mb-4" type="text" id="search" placeholder="Search player..." oninput="search_player(this);">
                    </div>

                </div>

                <table class="table custom-table" id="tablePlayers">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Country</th>
                            <th>Player</th>
                            <th>List Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if players %}
                        {% for player in players %}
                        <tr class="table-row">
                            <td class="position-cell">{{player.position}}</td>
                            <td class="country-cell"><img src="{{player.country.picture.url}}" height="20" class="d-inline-block align-top"/></td>
                            <td class="player-cell">
                                <a href="{% url 'users:detail' player.user.id %}" target="_blank">{{player.user.username}}</a>
                            </td>
                            <td class="list_points-cell">{{player.list_points}}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr class="table-row">
                            <td colspan="4" class="player-cell">
                                There have been no players yet
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>



        function search_player(player)
        {
        console.log(player.value);
        data = {}
        data.player = player.value;
        $.ajax({
            type: "post", // "post" "get" "delete" "put"
            data: data, // PREFERIBLEMENTE JSON
            cache: false,
            headers: {
            "X-CSRFToken": Cookies.get("csrftoken")
            },
            success: function (response) {
            $('#tablePlayers > tbody').empty();
            $(response).each(function (index, player) {
            var fila=`<tr class="table-row"><td class="position-cell">` + player.position + `</td>`;
                fila+=`<td class="country-cell"><img src="` + player.country__picture + `" height="20" class="d-inline-block align-top"/></td>`;
                fila+=`<td class="player-cell"><a href="{% url 'users:detail' 1234 %}" target="_blank">`.replace(/1234/, player.user__id) + player.user__username + `</a></td>`;
                fila+=`<td class="list_points-cell">` + player.list_points + `</td></tr>`;
                $('#tablePlayers > tbody').append(fila);
            })
            console.log(response.length)
            if (response.length == 0){
            var fila=`<tr class="table-row"><td colspan="4" class="player-cell">There have been no players yet</td></tr>`
            $('#tablePlayers > tbody').append(fila);
            }
            }
        })
    }

    function search_country(country)
        {
        console.log(country.value);
        data = {}
        data.country = country.value;
        $.ajax({
            type: "post", // "post" "get" "delete" "put"
            data: data, // PREFERIBLEMENTE JSON
            cache: false,
            headers: {
            "X-CSRFToken": Cookies.get("csrftoken")
            },
            success: function (response) {
            $('#tablePlayers > tbody').empty();
            var indiceColumnPlayer = $("#tablePlayers th:contains('Player')").index();
            $("#tablePlayers th, #tablePlayers td").filter(":nth-child(" + (indiceColumnPlayer + 1) + ")").remove();
            $("#search").attr("placeholder", "Search country...");
            $("#search").attr("oninput", "search_country(this);");
            $(response).each(function (index, player) {
                var fila=`<tr class="table-row"><td class="position-cell">` + player.position + `</td>`;
                fila+=`<td class="country-cell"><img src="` + player.picture + `" height="20" class="d-inline-block align-top" style="margin-right:15px"/>` + player.country + `</td>`;
                    fila+=`<td class="list_points-cell">` + player.list_points + `</td></tr>`;
                    $('#tablePlayers > tbody').append(fila);
                })
            if (response.length == 0){
            var fila=`<tr class="table-row"><td colspan="4" class="player-cell">There have been no players yet</td></tr>`
            $('#tablePlayers > tbody').append(fila);
            }
            }
        })
    }



    function update_table_status(option)
    {
    console.log(option.value);
    data = {}
    data.option = option.value;
    $.ajax({
        type: "post", // "post" "get" "delete" "put"
        data: data, // PREFERIBLEMENTE JSON
        cache: false,
        headers: {
        "X-CSRFToken": Cookies.get("csrftoken")
        },
        success: function (response) {
        $('#tablePlayers > tbody').empty();
        console.log(data.option )
        if (data.option == "Individual"){
            $('#country').attr("hidden", false);
            $("#tablePlayers thead tr th:nth-child(2)").after("<th>Player</th>");
            $("#tablePlayers tbody tr td:nth-child(2)").after("<td>Nombre del Jugador</td>");
            $("#search").attr("placeholder", "Search player...");
            $("#search").attr("oninput", "search_player(this);");
            $(response).each(function (index, player) {
                var fila=`<tr class="table-row"><td class="position-cell">` + player.position + `</td>`;
                    fila+=`<td class="country-cell"><img src="/media/` + player.country__picture + `" height="20" class="d-inline-block align-top"/></td>`;
                    fila+=`<td class="player-cell"><a href="{% url 'users:detail' 1234 %}" target="_blank">`.replace(/1234/, player.user__id) + player.user__username + `</a></td>`;
                    fila+=`<td class="list_points-cell">` + player.list_points + `</td></tr>`;
                    $('#tablePlayers > tbody').append(fila);
                })
        }
        else if (data.option == "Nations"){
            $('#country').attr("hidden", true);
            var indiceColumnPlayer = $("#tablePlayers th:contains('Player')").index();
            $("#tablePlayers th, #tablePlayers td").filter(":nth-child(" + (indiceColumnPlayer + 1) + ")").remove();
            $("#search").attr("placeholder", "Search country...");
            $("#search").attr("oninput", "search_country(this);");
            $(response).each(function (index, player) {
                var fila=`<tr class="table-row"><td class="position-cell">` + player.position + `</td>`;
                    fila+=`<td class="country-cell"><img src="/media/` + player.picture + `" height="20" class="d-inline-block align-top" style="margin-right:15px"/>` + player.country + `</td>`;
                    fila+=`<td class="list_points-cell">` + player.list_points + `</td></tr>`;
                    $('#tablePlayers > tbody').append(fila);
                })
        }
        
        console.log(response.length)
        if (response.length == 0){
        var fila=`<tr class="table-row"><td colspan="4" class="player-cell">There have been no players yet</td></tr>`
        $('#tablePlayers > tbody').append(fila);
        }
        }
    })
}

    function update_table_country(select_country)
        {
        console.log(select_country.value);
        data = {}
        data.select_country = select_country.value;

        $.ajax({
            type: "post", // "post" "get" "delete" "put"
            data: data, // PREFERIBLEMENTE JSON
            cache: false,
            headers: {
            "X-CSRFToken": Cookies.get("csrftoken")
            },
            success: function (response) {
            $('#tablePlayers > tbody').empty();
            console.log(data.select_country )
            var indiceColumnPlayer = $("#tablePlayers th:contains('Player')").index();
            $("#tablePlayers th, #tablePlayers td").filter(":nth-child(" + (indiceColumnPlayer + 1) + ")").remove();
            $("#tablePlayers thead tr th:nth-child(2)").after("<th>Player</th>");
            $("#tablePlayers tbody tr td:nth-child(2)").after("<td>Nombre del Jugador</td>");
            $("#search").attr("placeholder", "Search player...");
            $("#search").attr("oninput", "search_player(this);");
            $(response).each(function (index, player) {
                var fila=`<tr class="table-row"><td class="position-cell">` + player.position + `</td>`;
                    fila+=`<td class="country-cell"><img src="` + player.country__picture + `" height="20" class="d-inline-block align-top"/></td>`;
                    fila+=`<td class="player-cell"><a href="{% url 'users:detail' 1234 %}" target="_blank">`.replace(/1234/, player.user__id) + player.user__username + `</a></td>`;
                    fila+=`<td class="list_points-cell">` + player.list_points + `</td></tr>`;
                    $('#tablePlayers > tbody').append(fila);
                })
            console.log(response.length)
            if (response.length == 0){
            var fila=`<tr class="table-row"><td colspan="4" class="player-cell">There have been no players yet</td></tr>`
            $('#tablePlayers > tbody').append(fila);
            }
            }
            })
        }

    </script>
{% endblock %}